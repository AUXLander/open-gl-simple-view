<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<script language="javascript" type="text/javascript">
"use strict";
var output;
var ws;
var canvas;
var ctx;
var input;
var reader;
var u8arr;

window.addEventListener('load', () => {
    let wsUri = 'ws://' + window.location.hostname+ ':7654';

    input = document.getElementById('input');
    canvas = document.getElementById("canvas");
    ctx = canvas.getContext('2d');

    output = document.getElementById("output");

    ws = new WebSocket(wsUri);
    ws.onopen = () => {
        writeToScreen('CONNECTED', output);
        doSend('WebSocket rocks!');
    };
    
    ws.onclose = () => writeToScreen('<p style="color: red;">DISCONNECTED</p>');
    ws.onmessage = msg => writeToScreen('<p style="color: blue;">RESPONSE: ' + msg.data + '</p>');
    ws.onerror = msg => writeToScreen('<p style="color: red;">ERROR: ' + msg.data + '</p>');

}, false);

function writeToScreen(message) {

    console.log(message);

    return

    let p = document.createElement('p');
    p.style.wordWrap = 'break-word';
    p.innerHTML = message;

    // if (output.childNodes.length > 5) {
    //     output.removeChild(output.childNodes[0]);
    // }

    output.appendChild(p);
}

function makeCommand(command, value)
{
    return JSON.stringify({command, value});
}

function sendpng()
{
    var img = new Image();

    img.onload = function() {
        ctx.drawImage(img, 0, 0)
        canvas.toBlob(blo=>blo.arrayBuffer().then(b=>ws.send(b)))
    }

    img.src = URL.createObjectURL(input.files[0]);   
}

function doSend() {

    ws.send(makeCommand('min_layer', document.getElementById('min_layer_data').value));
    ws.send(makeCommand('max_layer', document.getElementById('max_layer_data').value));

    //ws.send(message);
}

function wsSendBinary() {
    const array = new Float32Array(5);

    for (var i = 0; i < array.length; ++i) {
        array[i] = i / 2;
    }

    doSend(array);
}

</script>
</head>
<body style="font-family: sans-serif; font-size: 1.5em">
    <h1>Пульт управления</h1>

    <input  style="font-size: 1.3em" type="text" id="min_layer_data" value="0"></input>
    <input  style="font-size: 1.3em" type="text" id="max_layer_data" value="5"></input>

    <input type='file' accept='image' capture='camera' id='input'>

    <button style="font-size: 1.3em" onClick="doSend()">set layers</button>
    <canvas id = 'canvas'></canvas>

    <div id="output"></div>
</body>
</html>